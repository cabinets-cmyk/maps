<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapping Pro</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Esri Leaflet -->
  <script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#141c2b; --text:#e7eefc; --muted:#a9b3c7; --accent:#4cb3ff;
      --border:#22304a;
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr; }

    header {
      display:flex; align-items:center; gap:.75rem; padding:.6rem .8rem;
      background:linear-gradient(180deg, #10192a, #0c1320); border-bottom:1px solid var(--border);
    }
    header h1 { font-size:1rem; margin:0; }
    .toolbar { margin-left:auto; display:flex; gap:.5rem; flex-wrap:wrap; }
    .btn {
      background:var(--panel); color:var(--text); border:1px solid var(--border);
      padding:.45rem .65rem; border-radius:.5rem; cursor:pointer; font-size:.9rem;
    }
    .btn[aria-pressed="true"] { outline:2px solid var(--accent); }
    #map { width:100%; height:100%; position:relative; }

    /* TOP-RIGHT floating controls */
    .top-controls {
      position:absolute; right:12px; top:12px; z-index:1100;
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;
      background:rgba(15,23,36,.75); border:1px solid var(--border);
      padding:8px; border-radius:10px; backdrop-filter:blur(6px);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .ctrl-btn { min-width:44px; min-height:36px; }

    /* Small legend shown when Fire Stations are on */
    .mini-legend {
      margin-top:6px;
      background:rgba(10,16,27,.9);
      border:1px solid var(--border);
      border-radius:8px;
      padding:6px 8px;
      font-size:.78rem;
      line-height:1.25;
      color:#d9e6ff;
      box-shadow:0 6px 14px rgba(0,0,0,.3);
      display:none; /* toggled via JS */
      width:max-content;
      max-width: 60vw;
    }
    .legend-row { display:flex; align-items:center; gap:6px; margin:3px 0; white-space:nowrap; }
    .dot {
      width:10px; height:10px; border-radius:50%;
      border:2px solid #001829; display:inline-block;
    }
    .dot.white { background:#ffffff; border-color:#1f2937; }
    .dot.red { background:#ff3b30; }
    .dot.orange { background:#ff9500; }
    .dot.green { background:#34c759; }
    .dot.blue { background:#0a84ff; }
    .dot.purple { background:#bf5af2; }

    /* Bottom sheet / popover for layers */
    .sheet-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: 1200;
      opacity: 0; visibility: hidden; transition: .2s;
    }
    .sheet {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 1201;
      background: var(--panel); border-top-left-radius: 14px; border-top-right-radius: 14px;
      border-top: 1px solid var(--border); transform: translateY(105%);
      transition: transform .25s ease-out;
      max-height: 70vh; overflow: auto; box-shadow: 0 -12px 30px rgba(0,0,0,.45);
    }
    .sheet.open { transform: translateY(0); }
    .sheet-backdrop.open { opacity: 1; visibility: visible; }
    .sheet header {
      position: sticky; top: 0; padding: .75rem .9rem; border-bottom: 1px solid var(--border);
      background: var(--panel);
      display:flex; align-items:center; justify-content:space-between;
      border-radius: 14px 14px 0 0;
    }
    .sheet h2 { font-size: 1rem; margin: 0; }
    .sheet .content { padding: .6rem .9rem .9rem; }
    .group { margin: .3rem 0 .8rem; }
    .group h3 { margin:.2rem 0 .4rem; font-size:.95rem; color:var(--muted); }
    .layer-row { display:flex; align-items:center; justify-content:space-between; padding:.28rem 0; }
    .layer-row label { display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .chip {
      font-size:.75rem; color:#d2dcf3; background:#0f1724; border:1px solid var(--border);
      padding:.15rem .5rem; border-radius:999px;
    }

    /* Wide screens: center dialog */
    @media (min-width: 880px) {
      .sheet { left: 50%; right: auto; transform: translate(-50%, 105%); width: 520px; border-radius:14px; }
      .sheet.open { transform: translate(-50%, 0); }
    }

    /* Geolocation visuals */
    .loc-accuracy { background: rgba(76,179,255,.15); border: 2px solid rgba(76,179,255,.25); }

    /* prompt modal for enabling location */
    .prompt-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 1400; display:none;
    }
    .prompt {
      position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
      background: #0f1724; border: 1px solid var(--border); border-radius: 12px;
      padding: 16px; width: min(92vw, 420px); z-index: 1401; display:none; color: var(--text);
      box-shadow: 0 20px 50px rgba(0,0,0,.5);
    }
    .prompt h3 { margin: 0 0 8px; font-size: 1rem; }
    .prompt p { margin: 0 0 12px; color: var(--muted); }
    .prompt .actions { display:flex; gap:8px; justify-content:flex-end; }
    .prompt .actions button { padding:.5rem .75rem; }

    /* toast */
    .toast {
      position: absolute; left: 50%; transform: translateX(-50%);
      bottom: 24px; background:#152339; color:var(--text);
      border:1px solid var(--border); border-radius:.5rem; padding:.45rem .6rem;
      box-shadow:0 10px 24px rgba(0,0,0,.35); z-index: 1100; font-size:.9rem;
      display:none;
    }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Mapping Pro</h1>
      <div class="toolbar">
        <button id="streetBtn" class="btn" aria-pressed="true">Street</button>
        <button id="satBtn" class="btn" aria-pressed="false">Satellite</button>
        <button id="resetBtn" class="btn">Reset view</button>
        <button id="locateBtn" class="btn" title="Show my location">My location</button>
        <button id="layersBtnHeader" class="btn" title="Layers">Layers</button>
      </div>
    </header>

    <div id="map" role="application" aria-label="WA map with DFES/DBCA/OEM layers">
      <!-- Top-right controls and mini legend container -->
      <div class="top-controls" aria-label="Map controls">
        <div style="display:flex; gap:10px;">
          <button id="topLocate" class="btn ctrl-btn" title="Show my location">üìç</button>
          <button id="topLayers" class="btn ctrl-btn" title="Layers">üß≠</button>
        </div>
        <div id="miniLegend" class="mini-legend" aria-live="polite" aria-label="Fire Stations legend">
          <div class="legend-row"><span class="dot white"></span> DFES Office</div>
          <div class="legend-row"><span class="dot purple"></span> CFRS</div>
          <div class="legend-row"><span class="dot red"></span> VFRS</div>
          <div class="legend-row"><span class="dot blue"></span> VFESU</div>
          <div class="legend-row"><span class="dot green"></span> BFB</div>
          <div class="legend-row"><span class="dot orange"></span> SESU</div>
        </div>
      </div>
    </div>

    <!-- Layers bottom sheet -->
    <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>
    <aside id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
      <header>
        <h2 id="sheetTitle">Layers</h2>
        <button id="closeSheet" class="btn" aria-label="Close">Close</button>
      </header>
      <div class="content">
        <div class="group">
          <h3>Boundaries</h3>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dfesRegions" /> DFES Regions</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="frsDistricts" /> Gazetted Fire Districts</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dbcaRegionalParks" /> DBCA Area (Regional Parks)</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dbcaRegions" /> DBCA Boundaries (Regions)</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="oemBoundaries" /> Emergency Management Boundaries</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="lgaBoundaries" /> LGA Boundaries</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="townsites" /> Townsites</label>
            <span class="chip">Layer</span>
          </div>
        </div>

        <div class="group">
          <h3>Facilities & Points</h3>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="fireStations" checked /> Fire Stations</label>
            <span class="chip">Points</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="iccSites" /> DBCA ICC Locations</label>
            <span class="chip">Points</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="hydrants" /> Hydrants</label>
            <span class="chip">Dynamic</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="standpipes" /> Stand Pipes</label>
            <span class="chip">Dynamic</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="ach" /> ACH</label>
            <span class="chip">Layer</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Location services prompt -->
    <div id="promptBackdrop" class="prompt-backdrop" aria-hidden="true"></div>
    <div id="locationPrompt" class="prompt" role="dialog" aria-modal="true" aria-labelledby="locPromptTitle" aria-hidden="true">
      <h3 id="locPromptTitle">Enable Location Services</h3>
      <p>To zoom to your current position, please enable Location Services for your browser.</p>
      <div class="actions">
        <button id="promptHelp" class="btn">How to enable</button>
        <button id="promptRetry" class="btn">Try again</button>
        <button id="promptClose" class="btn">Close</button>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    // Basemaps
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' });
    const satellite = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles ¬© Esri' });

    const map = L.map('map', { center: [-27, 121], zoom: 5, layers: [street] });
    const waBounds = L.latLngBounds(L.latLng(-35.5, 112.8), L.latLng(-13.3, 129.2));
    map.fitBounds(waBounds);

    // Services
    const svc = {
      dfesRegions: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/2',
      frsDistricts: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/3',
      dfesStations: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer/33',
      dbcaRegionalParks: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/4',
      dbcaRegions: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/5',
      iccSites: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Environment/MapServer/57',
      oemBoundaries: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/31',
      hydrants: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer/6',
      standpipes: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer/7',
      ach: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/People_and_Society/MapServer/18',
      lgaBoundaries: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/14',
      townsites: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/15'
    };

    // Styles
    const styles = {
      dfesRegion: { color:'#8ED8F9', weight:2, fillColor:'#8ED8F9', fillOpacity:0.08 },
      frsDistrict: { color:'#FF0000', weight:2, fillColor:'#FF0000', fillOpacity:0.06 },
      parks: { color:'#0072FE', weight:2, fillColor:'#0072FE', fillOpacity:0.05 },
      dbca: { color:'#DD99FF', weight:2, fillColor:'#DD99FF', fillOpacity:0.05 },
      oem: { color:'#6e6e6e', weight:1, fillColor:'#c9f2d0', fillOpacity:0.3 },
      lga: { color:'#666', weight:1, fillColor:'#ffdf80', fillOpacity:0.2 },
      generic: { color:'#4CB3FF', weight:1, fillColor:'#4CB3FF', fillOpacity:0.08 }
    };

    // Fire Stations styling by type
    function fireStationColor(typeRaw) {
      const t = String(typeRaw || '').trim().toUpperCase();
      if (t.includes('REGIONAL DIRECTORATE') || t === 'DFES' || t.includes('DFES')) return '#ffffff'; // DFES Office
      if (t === 'CFRS' || t.includes('CAREER FIRE')) return '#bf5af2'; // CFRS
      if (t === 'VFRS' || t.includes('VOLUNTEER FIRE AND RESCUE') || t.includes('FIRE & RESCUE')) return '#ff3b30'; // VFRS
      if (t === 'VFESU' || t.includes('VOLUNTEER FIRE & EMERGENCY')) return '#0a84ff'; // VFESU
      if (t === 'BFB' || t.includes('BUSH FIRE BRIGADE')) return '#34c759'; // BFB
      if (t === 'SESU' || t.includes('STATE EMERGENCY SERVICE')) return '#ff9500'; // SESU
      return '#ffd60a';
    }
    function fireStationMarkerStyle(type) {
      const fill = fireStationColor(type);
      const stroke = (fill.toLowerCase() === '#ffffff') ? '#1f2937' : '#001829';
      return { radius: 7, color: stroke, weight: 2, fillColor: fill, fillOpacity: 1 };
    }
    function fireStationPriority(typeRaw) {
      const t = String(typeRaw || '').trim().toUpperCase();
      if (t.includes('REGIONAL DIRECTORATE') || t === 'DFES' || t.includes('DFES')) return 6; // DFES Office
      if (t === 'CFRS' || t.includes('CAREER FIRE')) return 5;
      if (t === 'VFRS' || t.includes('VOLUNTEER FIRE AND RESCUE') || t.includes('FIRE & RESCUE')) return 4;
      if (t === 'VFESU' || t.includes('VOLUNTEER FIRE & EMERGENCY')) return 3;
      if (t === 'BFB' || t.includes('BUSH FIRE BRIGADE')) return 2;
      if (t === 'SESU' || t.includes('STATE EMERGENCY SERVICE')) return 1;
      return 0;
    }

    function withErrorLog(layer, name){
      layer.on && layer.on('requesterror', e => console.error(`Layer ${name} error:`, e));
      layer.on && layer.on('loading', () => console.log(`Loading ${name}...`));
      layer.on && layer.on('load', () => console.log(`Loaded ${name}`));
      return layer;
    }

    // Create panes by priority to ensure top-most rendering for overlaps
    const panes = {};
    function ensurePaneForPriority(priority){
      const key = `pane-fire-${priority}`;
      if (!panes[key]) {
        const p = map.createPane(key);
        p.style.zIndex = String(640 + priority); // higher priority => higher z-index
        panes[key] = key;
      }
      return panes[key];
    }

    // Feature layers
    const featureLayers = {
      dfesRegions: withErrorLog(L.esri.featureLayer({ url: svc.dfesRegions, style: styles.dfesRegion }), 'DFES Regions'),
      frsDistricts: withErrorLog(L.esri.featureLayer({ url: svc.frsDistricts, style: styles.frsDistrict }), 'Gazetted Fire Districts'),
      dbcaRegionalParks: withErrorLog(L.esri.featureLayer({ url: svc.dbcaRegionalParks, style: styles.parks }), 'DBCA Regional Parks'),
      dbcaRegions: withErrorLog(L.esri.featureLayer({ url: svc.dbcaRegions, style: styles.dbca }), 'DBCA Regions'),
      oemBoundaries: withErrorLog(L.esri.featureLayer({ url: svc.oemBoundaries, style: styles.oem }), 'OEM Boundaries'),
      lgaBoundaries: withErrorLog(L.esri.featureLayer({ url: svc.lgaBoundaries, style: styles.lga }), 'LGA Boundaries'),
      townsites: withErrorLog(L.esri.featureLayer({ url: svc.townsites, style: styles.generic }), 'Townsites'),
      fireStations: withErrorLog(L.esri.featureLayer({
        url: svc.dfesStations,
        pointToLayer: (geojson, latlng) => {
          const p = geojson.properties || {};
          const pri = fireStationPriority(p.type);
          const pane = ensurePaneForPriority(pri);
          return L.circleMarker(latlng, { ...fireStationMarkerStyle(p.type), pane });
        }
      }), 'Fire Stations'),
      iccSites: withErrorLog(L.esri.featureLayer({
        url: svc.iccSites,
        pointToLayer: (g, ll) => L.circleMarker(ll, { radius:6, color:'#000', weight:1.5, fillColor:'#000', fillOpacity:1 })
      }), 'DBCA ICC Locations'),
      ach: withErrorLog(L.esri.featureLayer({ url: svc.ach, style: styles.generic }), 'ACH')
    };

    // Dynamic map layers
    const mapImageLayers = {
      hydrants: withErrorLog(L.esri.dynamicMapLayer({
        url: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer',
        layers: [6], opacity: 0.95
      }), 'Hydrants (dynamic)'),
      standpipes: withErrorLog(L.esri.dynamicMapLayer({
        url: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer',
        layers: [7], opacity: 0.95
      }), 'Stand Pipes (dynamic)')
    };

    // Generic popups
    function bindSimplePopup(layer, titleField) {
      layer.bindPopup(function (l) {
        const p = l.feature && l.feature.properties ? l.feature.properties : {};
        const title = (titleField && p[titleField]) ? p[titleField] : (p.name || 'Feature');
        const rows = Object.entries(p).slice(0, 12).map(([k, v]) => `<div><strong>${k}</strong>: ${v ?? ''}</div>`).join('');
        return `<div class="popup"><h4>${title}</h4>${rows}</div>`;
      });
    }
    bindSimplePopup(featureLayers.dfesRegions, 'name');
    bindSimplePopup(featureLayers.frsDistricts, 'name');
    bindSimplePopup(featureLayers.dbcaRegionalParks, 'rpk_reg_park');
    bindSimplePopup(featureLayers.dbcaRegions, 'drg_region_name');
    bindSimplePopup(featureLayers.oemBoundaries, 'name');
    bindSimplePopup(featureLayers.lgaBoundaries, undefined);
    bindSimplePopup(featureLayers.townsites, undefined);
    bindSimplePopup(featureLayers.ach, undefined);

    // Fire Stations popup (displaynam then type)
    featureLayers.fireStations.bindPopup(function (layer) {
      const p = layer.feature?.properties || {};
      const display = p.displaynam || 'Station';
      const type = (p.type || '').toString().trim().toUpperCase();
      return `<div class="popup">
        <h4>${display}</h4>
        <div><strong>Type</strong>: ${type}</div>
      </div>`;
    });

    // Toggle logic
    const active = new Set();
    const layers = {
      dfesRegions: featureLayers.dfesRegions,
      frsDistricts: featureLayers.frsDistricts,
      dbcaRegionalParks: featureLayers.dbcaRegionalParks,
      dbcaRegions: featureLayers.dbcaRegions,
      oemBoundaries: featureLayers.oemBoundaries,
      lgaBoundaries: featureLayers.lgaBoundaries,
      townsites: featureLayers.townsites,
      fireStations: featureLayers.fireStations,
      iccSites: featureLayers.iccSites,
      ach: featureLayers.ach,
      hydrants: mapImageLayers.hydrants,
      standpipes: mapImageLayers.standpipes
    };

    function toggleLayer(key, on) {
      const layer = layers[key];
      if (!layer) return;
      if (on) {
        layer.addTo(map);
        active.add(key);
        if (key === 'fireStations') showMiniLegend(true);
      } else {
        map.removeLayer(layer);
        active.delete(key);
        if (key === 'fireStations') showMiniLegend(false);
      }
    }

    // Mini-legend show/hide
    const miniLegend = document.getElementById('miniLegend');
    function showMiniLegend(show) {
      miniLegend.style.display = show ? 'block' : 'none';
    }

    // Sheet open/close
    const sheet = document.getElementById('sheet');
    const backdrop = document.getElementById('backdrop');
    const layersBtnHeader = document.getElementById('layersBtnHeader');
    const topLayers = document.getElementById('topLayers');
    const closeSheet = document.getElementById('closeSheet');
    function openSheet(){ sheet.classList.add('open'); backdrop.classList.add('open'); sheet.setAttribute('aria-hidden','false'); backdrop.setAttribute('aria-hidden','false'); }
    function closeSheetFn(){ sheet.classList.remove('open'); backdrop.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); backdrop.setAttribute('aria-hidden','true'); }
    layersBtnHeader.onclick = openSheet;
    topLayers.onclick = openSheet;
    closeSheet.onclick = closeSheetFn;
    backdrop.onclick = closeSheetFn;

    // Connect checkboxes
    document.querySelectorAll('input[type=checkbox][data-layer]').forEach(cb => {
      cb.addEventListener('change', e => toggleLayer(e.target.dataset.layer, e.target.checked));
    });

    // Default visible
    ['dfesRegions','frsDistricts','fireStations'].forEach(k => {
      toggleLayer(k, true);
      const el = document.querySelector(`input[data-layer="${k}"]`);
      if (el) el.checked = true;
    });
    showMiniLegend(true); // reflect initial state

    // Basemap buttons
    const streetBtn = document.getElementById('streetBtn');
    const satBtn = document.getElementById('satBtn');
    function setBasemap(which) {
      if (which === 'street') {
        if (map.hasLayer(satellite)) map.removeLayer(satellite);
        if (!map.hasLayer(street)) map.addLayer(street);
        streetBtn.setAttribute('aria-pressed','true'); satBtn.setAttribute('aria-pressed','false');
      } else {
        if (map.hasLayer(street)) map.removeLayer(street);
        if (!map.hasLayer(satellite)) map.addLayer(satellite);
        streetBtn.setAttribute('aria-pressed','false'); satBtn.setAttribute('aria-pressed','true');
      }
    }
    streetBtn.onclick = () => setBasemap('street');
    satBtn.onclick = () => setBasemap('sat');

    // Fit/Reset
    document.getElementById('resetBtn').onclick = () => map.fitBounds(waBounds);

    // Show my Location (blue dot + accuracy)
    const toast = document.getElementById('toast');
    let userMarker = null;
    let accuracyCircle = null;

    function showToast(msg, ms=3000){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), ms);
    }

    function ensureLocationLayers(){
      if (!userMarker) {
        userMarker = L.circleMarker([0,0], { radius: 8, color: '#0b3d91', weight: 2, fillColor: '#2e7dff', fillOpacity: 1 });
      }
      if (!accuracyCircle) {
        accuracyCircle = L.circle([0,0], { radius: 0, className: 'loc-accuracy' });
      }
      if (!map.hasLayer(userMarker)) userMarker.addTo(map);
      if (!map.hasLayer(accuracyCircle)) accuracyCircle.addTo(map);
    }

    // Permissions helper using Permissions API where available
    async function checkGeolocationPermission() {
      if (!navigator.permissions || !navigator.permissions.query) return null;
      try {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        return status.state; // 'granted' | 'prompt' | 'denied'
      } catch { return null; }
    }

    // Location prompt modal controls
    const promptBackdrop = document.getElementById('promptBackdrop');
    const locPrompt = document.getElementById('locationPrompt');
    const promptHelp = document.getElementById('promptHelp');
    const promptRetry = document.getElementById('promptRetry');
    const promptClose = document.getElementById('promptClose');

    function openPrompt(){
      promptBackdrop.style.display = 'block';
      locPrompt.style.display = 'block';
      promptBackdrop.setAttribute('aria-hidden','false');
      locPrompt.setAttribute('aria-hidden','false');
    }
    function closePrompt(){
      promptBackdrop.style.display = 'none';
      locPrompt.style.display = 'none';
      promptBackdrop.setAttribute('aria-hidden','true');
      locPrompt.setAttribute('aria-hidden','true');
    }

    promptClose.onclick = closePrompt;
    promptRetry.onclick = () => { closePrompt(); requestLocation(true); };
    promptHelp.onclick = () => {
      // Try to open OS/browser settings guidance
      const ua = navigator.userAgent || '';
      if (/iPad|iPhone|iPod/i.test(ua)) {
        alert('On iPad/iPhone: Settings > Privacy & Security > Location Services > enable. Then in Safari: Settings > Safari > Location > Allow.');
      } else if (/Android/i.test(ua)) {
        alert('On Android: Settings > Location > turn on. In Chrome: Settings > Site settings > Location > Allow for this site.');
      } else {
        alert('Please enable Location Services in your OS, and allow location in your browser for this site.');
      }
    };

    function onLocationFound(e) {
      ensureLocationLayers();
      const latlng = e.latlng;
      userMarker.setLatLng(latlng);
      accuracyCircle.setLatLng(latlng).setRadius(e.accuracy || 0);

      // Always go to user's location when button pressed
      const r = accuracyCircle.getRadius();
      if (r > 0) {
        const dLat = (r / 111320);
        const dLng = dLat / Math.cos(latlng.lat * Math.PI / 180);
        const b = L.latLngBounds([latlng], [latlng.lat + dLat, latlng.lng + dLng], [latlng.lat - dLat, latlng.lng - dLng]);
        map.fitBounds(b.pad(0.6));
      } else {
        map.setView(latlng, Math.max(map.getZoom(), 16));
      }
      showToast('Location found', 1500);
    }

    function onLocationError(e) {
      console.warn('Geolocation error:', e);
      const msg = e && e.message ? e.message : 'Unable to get your location.';
      showToast(`Location error: ${msg}`);
      // If permission denied or unavailable, prompt user to enable
      const m = (msg + '').toLowerCase();
      if (m.includes('denied') || m.includes('permission') || m.includes('unavailable') || m.includes('disabled')) {
        openPrompt();
      }
    }

    async function requestLocation(fromRetry=false) {
      // If Permissions API says denied, show prompt immediately unless retry explicitly requested
      const perm = await checkGeolocationPermission();
      if (perm === 'denied' && !fromRetry) {
        openPrompt();
        return;
      }
      if (!('geolocation' in navigator)) {
        showToast('Geolocation not supported on this device.');
        return;
      }
      map.once('locationfound', onLocationFound);
      map.once('locationerror', onLocationError);
      map.locate({ setView: false, watch: false, enableHighAccuracy: true, timeout: 12000, maximumAge: 0 });
      showToast('Locating‚Ä¶', 1500);
    }

    // Hook buttons (header and top-right) to go to user location
    document.getElementById('locateBtn').onclick = () => requestLocation(false);
    document.getElementById('topLocate').onclick = () => requestLocation(false);
    document.getElementById('topLayers').onclick = openSheet;
  </script>
</body>
</html>
