<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>WA Emergency & Planning Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- Esri Leaflet -->
  <script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#141c2b; --text:#e7eefc; --muted:#a9b3c7; --accent:#4cb3ff;
      --border:#22304a; --danger:#ff4d4f; --ok:#28c76f;
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #app { height:100%; display:grid; grid-template-rows:auto 1fr; }

    header {
      display:flex; align-items:center; gap:.75rem; padding:.6rem .8rem;
      background:linear-gradient(180deg, #10192a, #0c1320); border-bottom:1px solid var(--border);
    }
    header h1 { font-size:1rem; margin:0; }
    .toolbar { margin-left:auto; display:flex; gap:.5rem; flex-wrap:wrap; }
    .btn {
      background:var(--panel); color:var(--text); border:1px solid var(--border);
      padding:.45rem .65rem; border-radius:.5rem; cursor:pointer; font-size:.9rem;
    }
    .btn[aria-pressed="true"] { outline:2px solid var(--accent); }
    #map { width:100%; height:100%; position:relative; }

    /* TOP-RIGHT floating controls (replacing bottom FABs) */
    .top-controls {
      position: absolute; right: 12px; top: 12px; z-index: 1100;
      display:flex; gap:10px; flex-wrap:wrap;
      background: rgba(15,23,36,.75);
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 10px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .ctrl-btn { min-width: 44px; min-height: 36px; }

    /* Bottom sheet / popover for layers */
    .sheet-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: 1200;
      opacity: 0; visibility: hidden; transition: .2s;
    }
    .sheet {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 1201;
      background: var(--panel); border-top-left-radius: 14px; border-top-right-radius: 14px;
      border-top: 1px solid var(--border); transform: translateY(105%);
      transition: transform .25s ease-out;
      max-height: 70vh; overflow: auto; box-shadow: 0 -12px 30px rgba(0,0,0,.45);
    }
    .sheet.open { transform: translateY(0); }
    .sheet-backdrop.open { opacity: 1; visibility: visible; }
    .sheet header {
      position: sticky; top: 0; padding: .75rem .9rem; border-bottom: 1px solid var(--border);
      background: var(--panel);
      display:flex; align-items:center; justify-content:space-between;
      border-radius: 14px 14px 0 0;
    }
    .sheet h2 { font-size: 1rem; margin: 0; }
    .sheet .content { padding: .6rem .9rem .9rem; }
    .group { margin: .3rem 0 .8rem; }
    .group h3 { margin:.2rem 0 .4rem; font-size:.95rem; color:var(--muted); }
    .layer-row { display:flex; align-items:center; justify-content:space-between; padding:.28rem 0; }
    .layer-row label { display:flex; align-items:center; gap:.5rem; cursor:pointer; }
    .chip {
      font-size:.75rem; color:#d2dcf3; background:#0f1724; border:1px solid var(--border);
      padding:.15rem .5rem; border-radius:999px;
    }

    /* Wide screens: center dialog */
    @media (min-width: 880px) {
      .sheet { left: 50%; right: auto; transform: translate(-50%, 105%); width: 520px; border-radius:14px; }
      .sheet.open { transform: translate(-50%, 0); }
    }

    /* Geolocation visuals */
    .loc-accuracy { background: rgba(76,179,255,.15); border: 2px solid rgba(76,179,255,.25); }

    /* toast for geolocation */
    .toast {
      position: absolute; left: 50%; transform: translateX(-50%);
      bottom: 24px; background:#152339; color:var(--text);
      border:1px solid var(--border); border-radius:.5rem; padding:.45rem .6rem;
      box-shadow:0 10px 24px rgba(0,0,0,.35); z-index: 1100; font-size:.9rem;
      display:none;
    }
    .toast.show { display:block; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>WA Emergency & Planning Map</h1>
      <div class="toolbar">
        <button id="streetBtn" class="btn" aria-pressed="true">Street</button>
        <button id="satBtn" class="btn" aria-pressed="false">Satellite</button>
        <button id="resetBtn" class="btn">Reset view</button>
        <button id="fitVisibleBtn" class="btn">Fit to layers</button>
        <button id="locateBtn" class="btn" title="Show my location">My location</button>
        <button id="layersBtnHeader" class="btn" title="Layers">Layers</button>
      </div>
    </header>

    <div id="map" role="application" aria-label="WA map with DFES/DBCA/OEM layers">
      <!-- Top-right floating controls (duplicate quick access for iPad visibility) -->
      <div class="top-controls" aria-label="Map controls">
        <button id="topLocate" class="btn ctrl-btn" title="Show my location">üìç</button>
        <button id="topLayers" class="btn ctrl-btn" title="Layers">üß≠</button>
      </div>
    </div>

    <!-- Layers bottom sheet -->
    <div id="backdrop" class="sheet-backdrop" aria-hidden="true"></div>
    <aside id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
      <header>
        <h2 id="sheetTitle">Layers</h2>
        <button id="closeSheet" class="btn" aria-label="Close">Close</button>
      </header>
      <div class="content">
        <div class="group">
          <h3>Boundaries</h3>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dfesRegions" /> DFES Regions</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="frsDistricts" /> Gazetted Fire Districts</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dbcaRegionalParks" /> DBCA Area (Regional Parks)</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dbcaRegions" /> DBCA Boundaries (Regions)</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="oemBoundaries" /> Emergency Management Boundaries</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="lgaBoundaries" /> LGA Boundaries</label>
            <span class="chip">Polygons</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="townsites" /> Townsites</label>
            <span class="chip">Layer</span>
          </div>
        </div>

        <div class="group">
          <h3>Facilities & Points</h3>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="dfesStations" /> DFES Stations</label>
            <span class="chip">Points</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="iccSites" /> DBCA ICC Locations</label>
            <span class="chip">Points</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="hydrants" /> Hydrants</label>
            <span class="chip">Dynamic</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="standpipes" /> Stand Pipes</label>
            <span class="chip">Dynamic</span>
          </div>

          <div class="layer-row">
            <label><input type="checkbox" data-layer="ach" /> ACH</label>
            <span class="chip">Layer</span>
          </div>
        </div>
      </div>
    </aside>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    // Basemaps
    const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OpenStreetMap' });
    const satellite = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles ¬© Esri' });

    const map = L.map('map', { center: [-27, 121], zoom: 5, layers: [street] });
    const waBounds = L.latLngBounds(L.latLng(-35.5, 112.8), L.latLng(-13.3, 129.2));
    map.fitBounds(waBounds);

    // Services
    const svc = {
      dfesRegions: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/2',
      frsDistricts: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/3',
      dfesStations: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer/33',
      dbcaRegionalParks: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/4',
      dbcaRegions: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/5',
      iccSites: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Environment/MapServer/57',
      oemBoundaries: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/31',
      hydrants: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer/6',
      standpipes: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer/7',
      ach: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/People_and_Society/MapServer/18',
      lgaBoundaries: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/14',
      townsites: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Boundaries/MapServer/15'
    };

    // Styles
    const styles = {
      dfesRegion: { color:'#8ED8F9', weight:2, fillColor:'#8ED8F9', fillOpacity:0.08 },
      frsDistrict: { color:'#FF0000', weight:2, fillColor:'#FF0000', fillOpacity:0.06 },
      parks: { color:'#0072FE', weight:2, fillColor:'#0072FE', fillOpacity:0.05 },
      dbca: { color:'#DD99FF', weight:2, fillColor:'#DD99FF', fillOpacity:0.05 },
      oem: { color:'#6e6e6e', weight:1, fillColor:'#c9f2d0', fillOpacity:0.3 },
      lga: { color:'#666', weight:1, fillColor:'#ffdf80', fillOpacity:0.2 },
      generic: { color:'#4CB3FF', weight:1, fillColor:'#4CB3FF', fillOpacity:0.08 }
    };
    const pointSym = (c) => ({ radius:6, color:'#00253b', weight:1, fillColor:c, fillOpacity:0.95 });

    function withErrorLog(layer, name){
      layer.on && layer.on('requesterror', e => console.error(`Layer ${name} error:`, e));
      layer.on && layer.on('loading', () => console.log(`Loading ${name}...`));
      layer.on && layer.on('load', () => console.log(`Loaded ${name}`));
      return layer;
    }

    // Feature layers
    const featureLayers = {
      dfesRegions: withErrorLog(L.esri.featureLayer({ url: svc.dfesRegions, style: styles.dfesRegion }), 'DFES Regions'),
      frsDistricts: withErrorLog(L.esri.featureLayer({ url: svc.frsDistricts, style: styles.frsDistrict }), 'FRS Districts'),
      dbcaRegionalParks: withErrorLog(L.esri.featureLayer({ url: svc.dbcaRegionalParks, style: styles.parks }), 'DBCA Regional Parks'),
      dbcaRegions: withErrorLog(L.esri.featureLayer({ url: svc.dbcaRegions, style: styles.dbca }), 'DBCA Regions'),
      oemBoundaries: withErrorLog(L.esri.featureLayer({ url: svc.oemBoundaries, style: styles.oem }), 'OEM Boundaries'),
      lgaBoundaries: withErrorLog(L.esri.featureLayer({ url: svc.lgaBoundaries, style: styles.lga }), 'LGA Boundaries'),
      townsites: withErrorLog(L.esri.featureLayer({ url: svc.townsites, style: styles.generic }), 'Townsites'),
      dfesStations: withErrorLog(L.esri.featureLayer({ url: svc.dfesStations, pointToLayer: (g, ll) => L.circleMarker(ll, pointSym('#ffcc00')) }), 'DFES Stations'),
      iccSites: withErrorLog(L.esri.featureLayer({ url: svc.iccSites, pointToLayer: (g, ll) => L.circleMarker(ll, pointSym('#00c853')) }), 'ICC Sites'),
      ach: withErrorLog(L.esri.featureLayer({ url: svc.ach, style: styles.generic }), 'ACH')
    };

    // Dynamic map layers for heavy point datasets
    const mapImageLayers = {
      hydrants: withErrorLog(L.esri.dynamicMapLayer({
        url: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer',
        layers: [6], opacity: 0.95
      }), 'Hydrants (dynamic)'),
      standpipes: withErrorLog(L.esri.dynamicMapLayer({
        url: 'https://public-services.slip.wa.gov.au/public/rest/services/SLIP_Public_Services/Infrastructure_and_Utilities/MapServer',
        layers: [7], opacity: 0.95
      }), 'Stand Pipes (dynamic)')
    };

    // Popups for feature layers (generic)
    function bindSimplePopup(layer, titleField) {
      layer.bindPopup(function (l) {
        const p = l.feature && l.feature.properties ? l.feature.properties : {};
        const title = (titleField && p[titleField]) ? p[titleField] : (p.name || 'Feature');
        const rows = Object.entries(p).slice(0, 12).map(([k, v]) => `<div><strong>${k}</strong>: ${v ?? ''}</div>`).join('');
        return `<div class="popup"><h4>${title}</h4>${rows}</div>`;
      });
    }
    bindSimplePopup(featureLayers.dfesRegions, 'name');
    bindSimplePopup(featureLayers.frsDistricts, 'name');
    bindSimplePopup(featureLayers.dbcaRegionalParks, 'rpk_reg_park');
    bindSimplePopup(featureLayers.dbcaRegions, 'drg_region_name');
    bindSimplePopup(featureLayers.oemBoundaries, 'name');
    bindSimplePopup(featureLayers.lgaBoundaries, undefined);
    bindSimplePopup(featureLayers.townsites, undefined);
    bindSimplePopup(featureLayers.dfesStations, 'displaynam');
    bindSimplePopup(featureLayers.iccSites, 'fic_site_name');
    bindSimplePopup(featureLayers.ach, undefined);

    // Toggle logic
    const active = new Set();
    const layers = {
      dfesRegions: featureLayers.dfesRegions,
      frsDistricts: featureLayers.frsDistricts,
      dbcaRegionalParks: featureLayers.dbcaRegionalParks,
      dbcaRegions: featureLayers.dbcaRegions,
      oemBoundaries: featureLayers.oemBoundaries,
      lgaBoundaries: featureLayers.lgaBoundaries,
      townsites: featureLayers.townsites,
      dfesStations: featureLayers.dfesStations,
      iccSites: featureLayers.iccSites,
      ach: featureLayers.ach,
      hydrants: mapImageLayers.hydrants,
      standpipes: mapImageLayers.standpipes
    };

    function toggleLayer(key, on) {
      const layer = layers[key];
      if (!layer) return;
      if (on) { layer.addTo(map); active.add(key); }
      else { map.removeLayer(layer); active.delete(key); }
    }

    // Sheet open/close
    const sheet = document.getElementById('sheet');
    const backdrop = document.getElementById('backdrop');
    const layersBtnHeader = document.getElementById('layersBtnHeader');
    const topLayers = document.getElementById('topLayers');
    const closeSheet = document.getElementById('closeSheet');
    function openSheet(){ sheet.classList.add('open'); backdrop.classList.add('open'); sheet.setAttribute('aria-hidden','false'); backdrop.setAttribute('aria-hidden','false'); }
    function closeSheetFn(){ sheet.classList.remove('open'); backdrop.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); backdrop.setAttribute('aria-hidden','true'); }
    layersBtnHeader.onclick = openSheet;
    topLayers.onclick = openSheet;
    closeSheet.onclick = closeSheetFn;
    backdrop.onclick = closeSheetFn;

    // Connect checkboxes
    document.querySelectorAll('input[type=checkbox][data-layer]').forEach(cb => {
      cb.addEventListener('change', e => toggleLayer(e.target.dataset.layer, e.target.checked));
    });

    // Default visible
    ['dfesRegions','frsDistricts','dfesStations'].forEach(k => {
      toggleLayer(k, true);
      const el = document.querySelector(`input[data-layer="${k}"]`);
      if (el) el.checked = true;
    });

    // Basemap buttons
    const streetBtn = document.getElementById('streetBtn');
    const satBtn = document.getElementById('satBtn');
    function setBasemap(which) {
      if (which === 'street') {
        if (map.hasLayer(satellite)) map.removeLayer(satellite);
        if (!map.hasLayer(street)) map.addLayer(street);
        streetBtn.setAttribute('aria-pressed','true'); satBtn.setAttribute('aria-pressed','false');
      } else {
        if (map.hasLayer(street)) map.removeLayer(street);
        if (!map.hasLayer(satellite)) map.addLayer(satellite);
        streetBtn.setAttribute('aria-pressed','false'); satBtn.setAttribute('aria-pressed','true');
      }
    }
    streetBtn.onclick = () => setBasemap('street');
    satBtn.onclick = () => setBasemap('sat');

    // Fit/Reset
    document.getElementById('resetBtn').onclick = () => map.fitBounds(waBounds);
    document.getElementById('fitVisibleBtn').onclick = () => {
      const bounds = L.latLngBounds([]);
      Object.entries(layers).forEach(([k, lyr]) => {
        if (active.has(k) && lyr.getBounds && lyr.getBounds().isValid()) bounds.extend(lyr.getBounds());
      });
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.05));
      else map.fitBounds(waBounds);
    };

    // Show my Location (blue dot + accuracy)
    const toast = document.getElementById('toast');
    let userMarker = null;
    let accuracyCircle = null;

    function showToast(msg, ms=3000){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), ms);
    }

    function ensureLocationLayers(){
      if (!userMarker) {
        userMarker = L.circleMarker([0,0], { radius: 8, color: '#0b3d91', weight: 2, fillColor: '#2e7dff', fillOpacity: 1 });
      }
      if (!accuracyCircle) {
        accuracyCircle = L.circle([0,0], { radius: 0, className: 'loc-accuracy' });
      }
      if (!map.hasLayer(userMarker)) userMarker.addTo(map);
      if (!map.hasLayer(accuracyCircle)) accuracyCircle.addTo(map);
    }

    function onLocationFound(e) {
      ensureLocationLayers();
      const latlng = e.latlng;
      userMarker.setLatLng(latlng);
      accuracyCircle.setLatLng(latlng).setRadius(e.accuracy || 0);
      const needsFit = !map.getBounds().contains(latlng);
      if (needsFit) {
        const r = accuracyCircle.getRadius();
        if (r > 0) {
          const dLat = (r / 111320);
          const dLng = dLat / Math.cos(latlng.lat * Math.PI / 180);
          const b = L.latLngBounds([latlng], [latlng.lat + dLat, latlng.lng + dLng], [latlng.lat - dLat, latlng.lng - dLng]);
          map.fitBounds(b.pad(0.6));
        } else {
          map.setView(latlng, Math.max(map.getZoom(), 14));
        }
      }
    }

    function onLocationError(e) {
      const reason = e && e.message ? e.message : 'Unable to get your location.';
      showToast(`Location error: ${reason}`);
    }

    function requestLocation() {
      if (!('geolocation' in navigator)) {
        showToast('Geolocation not supported on this device.');
        return;
      }
      map.once('locationfound', onLocationFound);
      map.once('locationerror', onLocationError);
      map.locate({ setView: false, watch: false, enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
      showToast('Locating‚Ä¶', 1500);
    }

    // Hook buttons (header and top-right)
    document.getElementById('locateBtn').onclick = requestLocation;
    document.getElementById('topLocate').onclick = requestLocation;
    document.getElementById('topLayers').onclick = openSheet;
  </script>
</body>
</html>
